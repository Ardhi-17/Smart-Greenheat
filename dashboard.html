<!DOCTYPE html>
<html lang="id">
<head>
  <!--
    ============================================================
    DASHBOARD — Smart GreenHeat (Dokumentasi & Komentar Lengkap)
    ============================================================

    Tujuan halaman:
    - Menampilkan kartu metrik (suhu, kelembapan, status).
    - Menampilkan grafik historis (Chart.js) dengan filter rentang.
    - Menyediakan kontrol (START/STOP/REFRESH) + Export CSV + Ganti Wi-Fi.
    - Menangani status online/offline perangkat (modal + kunci UI).
    - Navigasi bawah berbasis anchor (aman di GitHub Pages/Vercel → tanpa 404).

    Dependensi eksternal:
    - Font Awesome (ikon)
    - Chart.js (grafik)
    - Firebase (compat) untuk App, Database (RTDB), dan Auth
    - File lokal:
      - css/dashboard.css : gaya UI
      - firebase-config.js : inisialisasi Firebase milikmu (WAJIB)
        Harus mengisi window.database & window.auth
      - js/dashboard.js : logika UI, listener Firebase, kontrol, grafik, modal, watchdog online

    Struktur utama:
    - Loading Overlay (#loading-overlay) → disembunyikan via JS (dengan fallback).
    - Header (logo, judul, status user, tombol logout).
    - Bagian cards, chart, kontrol, pengaturan, modal logout, modal offline.
    - Mobile bottom navigation → anchor (#top, #chart-section, #control-section, #settings-section).
  -->

  <meta charset="UTF-8" />
  <!--
    Viewport: memastikan layout responsif di perangkat mobile
    - maximum-scale=1 untuk mencegah zoom otomatis pada beberapa perangkat
  -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>Dashboard - Smart GreenHeat</title>

  <!-- Favicon situs -->
  <link rel="icon" href="assets/images/logo.png" type="image/x-icon" />

  <!-- Stylesheet utama (tema, layout, komponen, modal, nav) -->
  <link rel="stylesheet" href="css/dashboard.css" />

  <!-- Ikon (Font Awesome) untuk dekorasi dan affordance tombol -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
  <!--
    ===================
    Loading Overlay
    ===================
    Tampil saat awal render; dihilangkan oleh js/dashboard.js dengan:
    - window.load
    - fallback timeout
    - window.error (agar tidak “loading terus” saat ada error)
  -->
  <div id="loading-overlay" class="loading-overlay" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <p>Memuat dashboard...</p>
  </div>

  <!--
    ===================
    Kontainer Utama
    ===================
    - Memberi padding & max-width, menjadi pembungkus semua section.
    - Memiliki id="top" agar menjadi anchor rujukan tombol "Dashboard".
  -->
  <div class="container" id="top">
    <!--
      ===== Header =====
      - Kiri: logo + judul.
      - Kanan: info pengguna + tombol Logout (disembunyikan sampai login).
    -->
    <header class="main-header">
      <div class="header-left">
        <div class="logo-container">
          <!-- Logo brand -->
          <img src="assets/images/logo.png" alt="Smart GreenHeat Logo" class="logo" />
          <h1>Smart GreenHeat Dashboard</h1>
        </div>
      </div>
      <div class="header-right">
        <div class="user-info">
          <!-- Diubah oleh JS setelah login: email user ditampilkan di sini -->
          <span id="user-status">👤 Guest</span>

          <!-- Tombol Logout:
               - Tersembunyi (class hidden) sebelum user terautentikasi.
               - onClick memanggil window.toggleAuth() → membuka modal konfirmasi logout. -->
          <button id="auth-btn" class="auth-button hidden" type="button"
                  onclick="toggleAuth()" aria-label="Logout" title="Logout">
            <i class="fas fa-right-from-bracket" aria-hidden="true"></i>
            Logout
          </button>
        </div>
      </div>
    </header>

    <!--
      ===== Dashboard (Cards) =====
      - Anchor #dashboard: opsional (tidak dipakai nav bawah, tapi aman untuk deep link).
      - Tiga kartu:
        1) Suhu: #temp-value + progress #temp-progress
        2) Kelembapan: #humidity-value + progress #humidity-progress
        3) Status running/stop + sumber kontrol (terakhir) #source-value
      - Data live diisi dari RTDB: /sensors dan /status
    -->
    <a id="dashboard" class="anchor"></a>
    <div class="stats-grid">
      <!-- Kartu Suhu -->
      <div class="stat-card">
        <div class="card-header">
          <i class="fas fa-thermometer-half icon-temperature" aria-hidden="true"></i>
          <h3>Suhu</h3>
        </div>
        <div class="card-content">
          <!-- Nilai suhu realtime (diisi JS), default “--” -->
          <p class="value" id="temp-value">--</p>
          <p class="unit">°C</p>
        </div>
        <!-- Progress bar suhu: diisi proporsional oleh JS -->
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="temp-progress"></div>
          </div>
          <div class="progress-labels">
            <span>0°C</span>
            <span>100°C</span>
          </div>
        </div>
      </div>

      <!-- Kartu Kelembapan -->
      <div class="stat-card">
        <div class="card-header">
          <i class="fas fa-tint icon-humidity" aria-hidden="true"></i>
          <h3>Kelembapan</h3>
        </div>
        <div class="card-content">
          <!-- Nilai kelembapan realtime -->
          <p class="value" id="humidity-value">--</p>
          <p class="unit">%</p>
        </div>
        <!-- Progress bar kelembapan -->
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="humidity-progress"></div>
          </div>
          <div class="progress-labels">
            <span>0%</span>
            <span>100%</span>
          </div>
        </div>
      </div>

      <!-- Kartu Status Sistem -->
      <div class="stat-card">
        <div class="card-header">
          <i class="fas fa-power-off icon-status" aria-hidden="true"></i>
          <h3>Status</h3>
        </div>
        <div class="card-content">
          <!-- RUNNING / STOPPED (diambil dari /status.running) -->
          <p class="value" id="status-value">--</p>
          <div class="status-source">
            <!-- Sumber kontrol terakhir (manual, auto, dsb) dari /status.lastCommandSource -->
            <span class="source-label">Kontrol:</span>
            <span id="source-value" class="source-text">--</span>
          </div>
        </div>
      </div>
    </div>

    <!--
      ===== Grafik Sensor =====
      - Anchor #chart-section untuk navigasi bawah.
      - Tombol filter rentang waktu (.range-btn) → data-min:
        15, 60, 360, 1440, “all”
      - Chart.js kanvas: #sensorChart
      - Data diambil dari RTDB /logs (persisten) → diproses & dirender oleh js/dashboard.js
    -->
    <a id="chart-section" class="anchor"></a>
    <div class="section" aria-disabled="true">
      <div class="section-header">
        <h2><i class="fas fa-chart-line" aria-hidden="true"></i> Grafik Sensor</h2>

        <!-- Tabs filter rentang: di-bind click oleh JS; saat offline → diblokir -->
        <div class="range-tabs" role="tablist" aria-label="Rentang waktu grafik">
          <button class="range-btn active" data-min="15">15m</button>
          <button class="range-btn" data-min="60">1h</button>
          <button class="range-btn" data-min="360">6h</button>
          <button class="range-btn" data-min="1440">24h</button>
          <button class="range-btn" data-min="all">All</button>
        </div>
      </div>

      <!-- Canvas untuk grafik Chart.js -->
      <div class="chart-wrapper">
        <canvas id="sensorChart" aria-label="Grafik suhu dan kelembapan" role="img"></canvas>
      </div>
    </div>

    <!--
      ===== Control Panel =====
      - Anchor #control-section untuk navigasi bawah.
      - Tombol Export → unduh CSV dari cache logs sesuai rentang aktif.
      - Tombol Ganti Wi-Fi → kirim perintah 'wifi_reconfig' (perangkat masuk mode portal).
      - START → set /controls/action = "start"
        STOP  → set /controls/action = "stop"
        REFRESH → "reboot"
      - Semua tombol otomatis terkunci saat offline (via js/dashboard.js)
    -->
    <a id="control-section" class="anchor"></a>
    <div class="section" aria-disabled="true">
      <div class="section-header">
        <h2><i class="fas fa-bolt" aria-hidden="true"></i> Kontrol Sistem</h2>

        <div class="control-right">
          <!-- Ekspor CSV dari cache logs -->
          <button class="export-btn" type="button" onclick="exportData()">
            <i class="fas fa-download" aria-hidden="true"></i> Export
          </button>

          <!-- Memicu wifi_reconfig (hanya saat online & logged-in) -->
          <button class="wifi-btn" type="button" onclick="wifiReconfig()">
            <i class="fas fa-wifi" aria-hidden="true"></i> Ganti Wi-Fi
          </button>
        </div>
      </div>

      <!-- Tombol kontrol utama sistem -->
      <div class="control-buttons">
        <button class="control-btn btn-success" type="button" onclick="sendCommand('start')">
          <i class="fas fa-play" aria-hidden="true"></i> START
        </button>

        <button class="control-btn btn-danger" type="button" onclick="sendCommand('stop')">
          <i class="fas fa-stop" aria-hidden="true"></i> STOP
        </button>

        <button class="control-btn btn-info" type="button" onclick="refreshData()">
          <i class="fas fa-sync-alt" aria-hidden="true"></i> REFRESH
        </button>
      </div>
    </div>

    <!--
      ===== Pengaturan (Placeholder) =====
      - Disiapkan agar anchor #settings-section ada (mencegah 404 / dead link).
      - Pada versi berikutnya, bagian ini bisa diisi kartu-kartu pengaturan:
        Jaringan (dengan sticky action di bawah), Batas/Alarm, Jadwal, Kalibrasi, dsb.
    -->
    <a id="settings-section" class="anchor"></a>
    <div class="section">
      <div class="section-header">
        <h2><i class="fas fa-cog" aria-hidden="true"></i> Pengaturan</h2>
      </div>
      <p>
        Halaman pengaturan akan ditambahkan di versi berikutnya.
        Sementara ini, penggantian Wi-Fi bisa dari tombol <b>Ganti Wi-Fi</b> pada bagian Kontrol Sistem.
      </p>
    </div>

    <!--
      ===== Modal Logout =====
      - Dibuka oleh toggleAuth() (JS).
      - Konfirmasi sebelum memanggil auth.signOut().
    -->
    <div id="logout-modal" class="modal" aria-hidden="true">
      <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="logout-title">
        <div class="modal-header">
          <h2 id="logout-title">
            <i class="fas fa-right-from-bracket" aria-hidden="true"></i> Konfirmasi Logout
          </h2>
          <!-- Tombol X untuk menutup modal -->
          <span class="close" role="button" tabindex="0" onclick="closeModal()" aria-label="Tutup">&times;</span>
        </div>

        <div class="modal-body">
          <p>Apakah Anda yakin ingin keluar dari dashboard?</p>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" onclick="closeModal()">
            <i class="fas fa-times btn-icon" aria-hidden="true"></i> Batal
          </button>
          <button class="btn btn-danger" type="button" onclick="logout()">
            <i class="fas fa-power-off btn-icon" aria-hidden="true"></i> Logout
          </button>
        </div>
      </div>
    </div>

    <!--
      ===== Modal: Mesin Offline =====
      - Ditampilkan otomatis saat perangkat dianggap offline oleh watchdog:
        (navigator.onLine === false) ATAU heartbeat /status/lastSeen tidak fresh.
      - Saat modal ini aktif, JS juga mengunci semua kontrol (disable).
    -->
    <div id="device-offline-modal" class="modal" aria-hidden="true">
      <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="offline-title">
        <div class="modal-header">
          <h2 id="offline-title"><i class="fas fa-wifi-slash" aria-hidden="true"></i> Mesin Offline</h2>
          <span class="close" role="button" tabindex="0" onclick="showOfflineModal(false)" aria-label="Tutup">&times;</span>
        </div>

        <div class="modal-body">
          <p><strong>Hubungkan koneksi internet pada Mesin</strong> agar kontrol dapat digunakan.</p>
          <ul style="margin-left:1rem">
            <li>Periksa Wi-Fi/internet ESP32</li>
            <li>Pastikan daya menyala</li>
            <li>Tunggu beberapa detik hingga tersambung kembali</li>
          </ul>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" onclick="showOfflineModal(false)">
            <i class="fas fa-check btn-icon" aria-hidden="true"></i> Oke
          </button>
        </div>
      </div>
    </div>
  </div>

  <!--
    ================================
    Mobile Bottom Navigation (Anchor)
    ================================
    - Masing-masing <a> menuju anchor di halaman yang sama:
      #top, #chart-section, #control-section, #settings-section
    - Aman di GitHub Pages/Vercel (tanpa memicu 404).
    - JS men-set class .active berdasar hash saat ini (opsional).
  -->
  <nav class="mobile-nav" aria-label="Bottom navigation">
    <a href="#top" class="nav-item" data-target="#top">
      <i class="fas fa-home" aria-hidden="true"></i>
      <span>Dashboard</span>
    </a>
    <a href="#chart-section" class="nav-item" data-target="#chart-section">
      <i class="fas fa-chart-line" aria-hidden="true"></i>
      <span>Grafik</span>
    </a>
    <a href="#control-section" class="nav-item" data-target="#control-section">
      <i class="fas fa-gamepad" aria-hidden="true"></i>
      <span>Kontrol</span>
    </a>
    <a href="#settings-section" class="nav-item" data-target="#settings-section">
      <i class="fas fa-cog" aria-hidden="true"></i>
      <span>Pengaturan</span>
    </a>
  </nav>

  <!--
    ===================
    Firebase compat SDK
    ===================
    Urutan penting (App → Database → Auth). Versi compat memudahkan transisi
    dari v8 style API. Gunakan firebase-config.js untuk initializeApp dan
    expose window.database & window.auth agar bisa dipakai dashboard.js.
  -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>

  <!--
    ===========
    Chart.js
    ===========
    Dipakai untuk rendering grafik time-series suhu & kelembapan.
  -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!--
    ============================
    Inisialisasi Firebase (WAJIB)
    ============================
    File ini HARUS mendefinisikan:
      window.database = firebase.database();
      window.auth = firebase.auth();
    Jika tidak → dashboard.js akan menandai "Firebase tidak terdeteksi",
    menampilkan toast peringatan, mengunci UI, dan memunculkan modal offline.
  -->
  <script src="firebase-config.js"></script>

  <!--
    ============================
    Logic Dashboard (Custom JS)
    ============================
    Berisi:
    - Robust loader hide (anti “loading terus”).
    - Auth guard (redirect ke login.html jika belum login).
    - Realtime listeners (/sensors, /status, /status/lastSeen).
    - Watchdog online/offline (heartbeat + navigator.onLine).
    - Render Chart.js dari /logs (filter rentang).
    - Export CSV, START/STOP/REFRESH, wifiReconfig (portal).
    - Modal logout & offline.
    - Mobile anchor-nav (smooth scroll + .active).
  -->
  <script src="js/dashboard.js"></script>
</body>
</html>
